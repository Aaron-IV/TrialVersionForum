<!doctype html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{.Post.Title}} - Forum</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Ваш CSS (в нём уже есть white-space: pre-wrap) -->
    <link href="/static/forum.css?v=4" rel="stylesheet">

    <script src="/static/reactions.js"></script>
    <script src="/static/backtotop.js"></script>
</head>
<body>

<header class="blog-header py-3">
    <div class="container">
        <div class="row flex-nowrap justify-content-between align-items-center">
            <div class="col-4 pt-1">
                {{if .User}}
                <span style="color:#767676;font-weight:500;">Welcome, {{.User.Username}}</span>
                {{else}}
                <a class="link-secondary" href="/login"
                   style="color:#767676;text-decoration:none;font-weight:500;">Login</a> |
                <a class="link-secondary" href="/register"
                   style="color:#767676;text-decoration:none;font-weight:500;">Register</a>
                {{end}}
            </div>
            <div class="col-4 text-center">
                <a class="blog-header-logo" href="/">Forum</a>
            </div>
            <div class="col-4 d-flex justify-content-end align-items-center">
                {{if .User}}
                <a class="btn btn-sm btn-outline-secondary" href="/logout"
                   style="border-color:#e1e1e1;color:#767676;">Logout</a>
                {{end}}
            </div>
        </div>
    </div>
</header>

<div class="post-detail-container">
    <div class="post-detail-card">
        <h1 class="post-detail-title">{{.Post.Title}}</h1>

        <div class="post-detail-meta">
            {{.Post.CreatedAt}} by {{.Post.Author}}
            {{if .Post.Categories}}
            <span style="margin:0 .5rem;">•</span>
            {{range .Post.Categories}}
            <a href="/?category={{.ID}}" class="badge"
               style="background:#f0f0f0;color:#767676;font-size:.75rem;padding:.25rem .5rem;margin-right:.25rem;border-radius:12px;text-decoration:none;">
                {{.Name}}
            </a>
            {{end}}
            {{end}}
            <span style="margin:0 .5rem;">•</span>
            <span>{{len .Comments}} comments</span>
        </div>

        <!--  КЛЮЧЕВОЕ ИЗМЕНЕНИЕ  -->
        <!--  1. Убираем любой фильтр, превращающий \n в пробелы  -->
        <!--  2. Выводим как обычный текст (не HTML)  -->
        <div class="post-detail-content">{{.Post.Content}}</div>
        <!--  -----------------------------------------------  -->

        <div class="pinterest-card-actions">
            <a href="#" data-type="post" data-id="{{.Post.ID}}" data-like="1"
               class="pinterest-btn pinterest-btn-like reaction-btn">
                Heart <span class="likes-count">{{.Post.Likes}}</span>
            </a>
            <a href="#" data-type="post" data-id="{{.Post.ID}}" data-like="0"
               class="pinterest-btn pinterest-btn-dislike reaction-btn">
                Dislike <span class="dislikes-count">{{.Post.Dislikes}}</span>
            </a>

            {{if and .User (eq .User.Username .Post.Author)}}
            <a href="/edit_post?id={{.Post.ID}}"
               class="pinterest-btn pinterest-btn-edit">Edit</a>
            <form method="POST" action="/delete_post?id={{.Post.ID}}"
                  style="display:inline"
                  onsubmit="return confirm('Delete this post?');">
                <input type="hidden" name="_method" value="DELETE">
                <button type="submit"
                        class="pinterest-btn pinterest-btn-delete">Delete</button>
            </form>
            {{end}}
        </div>
    </div>

    <!-- ==================  КОММЕНТАРИИ  ================== -->
    <div class="comments-section">
        <h4 style="color:#333;font-weight:600;margin-bottom:1.5rem;">Comments</h4>

        {{if .Comments}}
            {{range .Comments}}
            <div class="comment-card">
                <div class="comment-author">{{.Author}}</div>
                <div class="comment-date">{{.CreatedAt}}</div>

                <!--  Тоже выводим как обычный текст  -->
                <div class="comment-content">{{.Content}}</div>

                <div class="pinterest-card-actions">
                    <a href="#" data-type="comment" data-id="{{.ID}}" data-like="1"
                       class="pinterest-btn pinterest-btn-like reaction-btn">
                        Heart <span class="likes-count">{{.Likes}}</span>
                    </a>
                    <a href="#" data-type="comment" data-id="{{.ID}}" data-like="0"
                       class="pinterest-btn pinterest-btn-dislike reaction-btn">
                        Dislike <span class="dislikes-count">{{.Dislikes}}</span>
                    </a>

                    {{if and $.User (eq $.User.Username .Author)}}
                    <a href="/edit_comment?id={{.ID}}&post={{$.Post.ID}}"
                       class="pinterest-btn pinterest-btn-edit">Edit</a>
                    <form method="POST"
                          action="/delete_comment?id={{.ID}}&post={{$.Post.ID}}"
                          style="display:inline"
                          onsubmit="return confirm('Delete this comment?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit"
                                class="pinterest-btn pinterest-btn-delete">Delete</button>
                    </form>
                    {{end}}
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="text-center" style="color:#767676;padding:2rem;">
                <p>No comments yet. Be the first to comment!</p>
            </div>
        {{end}}

        {{if .User}}
        <form method="post" class="mt-4">
            <div class="mb-3">
                <label for="comment" class="form-label">Add a comment:</label>
                <textarea class="form-control" id="comment" name="comment"
                          rows="3" maxlength="500" required
                          placeholder="Share your thoughts..."></textarea>
            </div>
            <button type="submit"
                    class="pinterest-btn pinterest-btn-like">Submit Comment</button>
        </form>
        {{else}}
        <div class="text-center mt-4" style="color:#767676;">
            <p><a href="/login" style="color:#e60023;text-decoration:none;">Login</a> to comment.</p>
        </div>
        {{end}}
    </div>
</div>

<footer class="blog-footer">
    <a href="#top" id="back-to-top">Back to top</a>
</footer>

</body>
</html>